{% extends "layouts/base.html" %}

{% block title %} Case Analyze {% endblock %}

{% block content %}
<!-- Font Awesome 아이콘 사용을 위한 추가 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHq6j6hZT24ABWcT2phV6lEMAx+aAXeqDYX1wWYZQJTxihZ8t8Od8P7xgnDaQ6EwtEJBePbg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ breadcrumb ] start -->
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="page-header-title">
                            <h5 class="m-b-10">TAG 조회 결과</h5>
                        </div>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#">Case</a></li>
                            <li class="breadcrumb-item"><a href="#">Analyze</a></li>
                            <li class="breadcrumb-item"><a href="#">TAG</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ breadcrumb ] end -->

        <!-- [ Main Content ] start -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <h5>TAG Result</h5>
                    </div>
                    <div class="card-body">
                        <h5>Priority Classification Table</h5>

                        <!-- Grouped by Group (High, Medium, Low) -->
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>이상수치</th>
                                        <th>설명</th>
                                        <th>태그</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- High Group -->
                                    <tr>
                                        <td><strong>높음</strong></td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'High' %}
                                                <strong>{{ item.description }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'High' %}
                                                <!-- 태그 클릭 시 모달을 띄움 -->
                                                <a href="#" class="tag-link" data-bs-toggle="modal" data-bs-target="#flashModal" data-tag="{{ item.name }}">
                                                    <strong>{{ item.name }}</strong>  
                                                    {% if tag_count_dict[item.name] %}
                                                        ({{ tag_count_dict[item.name] }})
                                                    {% else %}
                                                        (0)
                                                    {% endif %}
                                                </a> <br>
                                            {% endfor %}
                                        </td>
                                    </tr>

                                    <!-- Medium Group -->
                                    <tr>
                                        <td><strong>중간</strong></td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Medium' %}
                                                <strong>{{ item.description }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Medium' %}
                                                <a href="#" class="tag-link" data-bs-toggle="modal" data-bs-target="#flashModal" data-tag="{{ item.name }}">
                                                    <strong>{{ item.name }}</strong>  
                                                    {% if tag_count_dict[item.name] %}
                                                        ({{ tag_count_dict[item.name] }})
                                                    {% else %}
                                                        (0)
                                                    {% endif %}
                                                </a> <br>
                                            {% endfor %}
                                        </td>
                                    </tr>

                                    <!-- Low Group -->
                                    <tr>
                                        <td><strong>낮음</strong></td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Low' %}
                                                <strong>{{ item.description }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Low' %}
                                                <a href="#" class="tag-link" data-bs-toggle="modal" data-bs-target="#flashModal" data-tag="{{ item.name }}">
                                                    <strong>{{ item.name }}</strong>  
                                                    {% if tag_count_dict[item.name] %}
                                                        ({{ tag_count_dict[item.name] }})
                                                    {% else %}
                                                        (0)
                                                    {% endif %}
                                                </a> <br>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</div>

<!-- 모달 HTML -->
<div class="modal fade" id="flashModal" tabindex="-1" aria-labelledby="flashModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- 모달 크기를 크게 설정 -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="flashModalLabel">태그 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;"> <!-- 스크롤 추가 -->
                <!-- 모달에 태그 정보를 동적으로 삽입 -->
                <div id="modal-tag-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- CSS 스타일 추가 -->
<style>
    /* 모달 크기 조정 */
    .modal-lg {
        max-width: 50%; /* 모달의 최대 너비 설정 */
    }

    /* 테이블 너비 및 스크롤 처리 */
    .modal-body {
        word-wrap: break-word;
    }

    /* 긴 텍스트 줄바꿈 및 테이블 안에 넘치지 않도록 설정 */
    table.table td {
        word-wrap: break-word;
        white-space: normal;
        max-width: 400px; /* 텍스트가 줄바꿈될 최대 너비 */
        overflow-wrap: break-word;
    }
</style>

<!-- JavaScript 코드 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tagLinks = document.querySelectorAll('.tag-link');
        tagLinks.forEach(function (link) {
            link.addEventListener('click', function () {
                var tag = this.getAttribute('data-tag');
                
                // 해당 태그에 대한 데이터를 result_dict에서 찾아 모달에 표시
                var resultDict = {{ result_dict|tojson }};
                var modalContent = document.getElementById('modal-tag-content');
                
                // 모달 본문 초기화
                modalContent.innerHTML = '';

                // 태그와 관련된 데이터를 담는 배열
                var foundData = [];

                // 태그와 관련된 모든 데이터를 탐색
                for (var category in resultDict) {
                    resultDict[category].forEach(function (item) {
                        // 각 item의 모든 키를 순회
                        for (var key in item) {
                            // 해당 키에 '_Tag_'가 있는지 확인
                            if (item[key] && item[key]['_Tag_'] === tag) {
                                // 데이터를 배열에 저장
                                foundData.push({ key: key, data: item[key] });
                            }
                        }
                    });
                }

                // 모달에 데이터를 테이블로 출력
                if (foundData.length > 0) {
                    foundData.forEach(function (entry, index) {
                        var tableHTML = `
                            <h5>` + (index + 1) + `. ` + entry.key + `</h5>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Key</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        // 각 데이터의 키-값 쌍을 테이블 행으로 추가
                        for (var dataKey in entry.data) {
                            tableHTML += `
                                <tr>
                                    <td>` + dataKey + `</td>
                                    <td>` + entry.data[dataKey] + `</td>
                                </tr>`;
                        }

                        tableHTML += `
                                </tbody>
                            </table>`;

                        modalContent.innerHTML += tableHTML;
                    });
                } else {
                    modalContent.innerHTML = '해당 태그에 대한 정보가 없습니다.';
                }
            });
        });
    });
</script>




{% endblock content %}
