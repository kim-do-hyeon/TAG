{% extends "layouts/base.html" %}

{% block title %} Case Analyze {% endblock %}

{% block content %}
<!-- Font Awesome 아이콘 사용을 위한 추가 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHq6j6hZT24ABWcT2phV6lEMAx+aAXeqDYX1wWYZQJTxihZ8t8Od8P7xgnDaQ6EwtEJBePbg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ breadcrumb ] start -->
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="page-header-title">
                            <h5 class="m-b-10">TAG 조회 결과</h5>
                        </div>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#">Case</a></li>
                            <li class="breadcrumb-item"><a href="#">Analyze</a></li>
                            <li class="breadcrumb-item"><a href="#">TAG</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ breadcrumb ] end -->

        <!-- [ Main Content ] start -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <h5>TAG Result</h5>
                    </div>
                    <div class="card-body">
                        <h5>Priority Classification Table</h5>

                        <!-- Grouped by Group (High, Medium, Low) -->
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>이상수치</th>
                                        <th>설명</th>
                                        <th>태그</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- High Group -->
                                    <tr>
                                        <td><strong>높음</strong></td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'High' %}
                                                <strong>{{ item.description }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'High' %}
                                                <strong>{{ item.name }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                    </tr>

                                    <!-- Medium Group -->
                                    <tr>
                                        <td><strong>중간</strong></td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Medium' %}
                                                <strong>{{ item.description }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Medium' %}
                                                <strong>{{ item.name }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                    </tr>

                                    <!-- Low Group -->
                                    <tr>
                                        <td><strong>낮음</strong></td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Low' %}
                                                <strong>{{ item.description }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for item in sorted_structured_data_dynamic if item.group == 'Low' %}
                                                <strong>{{ item.name }}</strong>  <br>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-body">
                        
                        <!-- Gmail Subject to Web PDF Download -->
                        
                        <style>
                            /* 테이블 셀 내에서 긴 텍스트 줄바꿈 */
                            table.table td {
                                word-wrap: break-word;
                                white-space: normal;
                                max-width: 400px; /* 텍스트가 줄바꿈될 최대 너비 */
                                overflow-wrap: break-word; /* 긴 단어도 줄바꿈 */
                            }
                            /* 화살표 스타일 */
                            .arrow-icon {
                                font-size: 24px;
                                color: #333;
                                text-align: center;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                        </style>
                        
                        <div class="row">
                            {% for key, value in result_dict.items() %}
                                <div class="col-md-12">
                                    <div class="row">
                                        {% for key, value in result_dict.items() %}
                                        <h5>
                                            <a data-bs-toggle="collapse" href="#{{key}}" role="button" aria-expanded="false" aria-controls="collapseGmailPDF">
                                                {{key }}
                                            </a>
                                        </h5>
                                            <div class="col-md-12">
                                                {% if value is iterable and not value is string %}
                                                    <!-- 리스트일 경우 각 항목을 순회 -->
                                                    {% for item in value %}
                                                        <!-- item이 딕셔너리인 경우 처리 -->
                                                        {% if item is mapping %}
                                                            <h4>{{ loop.index }}번째 항목 Node </h4>
                                                            
                                                            {% if 'body' in item %}
                                                                <div>
                                                                    {{ item['body']|safe }}
                                                                </div>
                                                            {% endif %}
                                                    
                                                            {% if 'script' in item %}
                                                                <div>
                                                                    {{ item['script']|safe }}
                                                                </div>
                                                            {% endif %}
                                                    
                                                            <!-- 나머지 데이터를 테이블로 출력 -->
                                                            <div class="row">
                                                                {% set index = 0 %}
                                                                {% for key, value in item.items() %}
                                                                    {% if key != 'body' and key != 'script' %}
                                                                        <!-- 좌우로 나누기 위해 index를 기준으로 나눔 -->
                                                                        <div class="col-md-5">
                                                                            <!-- 각 key를 기준으로 테이블 생성 -->
                                                                            <h4>{{ key|capitalize }} Log</h4>
                                                                            <table class="table table-striped">
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th>Key</th>
                                                                                        <th>Value</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% if value is mapping %}
                                                                                        <!-- value가 딕셔너리일 때만 순회 -->
                                                                                        {% for subkey, subvalue in value.items() %}
                                                                                            {% if subkey != 'body' and subkey != 'script' %}
                                                                                                <tr>
                                                                                                    <td>{{ subkey }}</td>
                                                                                                    <td>{{ subvalue }}</td>
                                                                                                </tr>
                                                                                            {% endif %}
                                                                                        {% endfor %}
                                                                                    {% else %}
                                                                                        <tr>
                                                                                            <td colspan="2">{{ value }}</td>
                                                                                        </tr>
                                                                                    {% endif %}
                                                                                </tbody>
                                                                            </table>
                                                                        </div>

                                                                        <!-- 화살표 추가 -->
                                                                        {% if index is divisibleby 2 %}
                                                                        <div class="col-md-2 arrow-icon">
                                                                            <i class="fas fa-arrow-right"></i>
                                                                        </div>
                                                                        {% endif %}

                                                                        {% set index = index + 1 %}
                                                                    
                                                                        <!-- 두 테이블마다 새로운 row를 시작하여 좌우 테이블 나누기 -->
                                                                        {% if index is divisibleby 2 %}
                                                                            </div><div class="row">
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        {% else %}
                                                            <!-- item이 딕셔너리가 아닌 경우 -->
                                                            <p>{{ item }}</p>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    <!-- value가 리스트가 아닌 경우 처리 -->
                                                    <p>{{ value }}</p>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div> 
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</div>

{% endblock content %}
