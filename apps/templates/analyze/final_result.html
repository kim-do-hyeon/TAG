{% extends "layouts/base.html" %}

{% block title %} Final Analyze {% endblock %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
{% block content %}
<div class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ breadcrumb ] start -->
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="page-header-title">
                            <h5 class="m-b-10">최종 필터링 결과</h5>
                        </div>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#">Case</a></li>
                            <li class="breadcrumb-item"><a href="#">Analyze</a></li>
                            <li class="breadcrumb-item"><a href="#">Filtering</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ breadcrumb ] end -->
        <!-- [ Main Content ] start -->
        
        
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <table class="table table-bordered">
                        <tr>
                            <th>No</th>
                            <th>사건 유형</th>
                            <td>행위 대상</td>
                            <th>시간대</th>
                            <th>설명</th>
                            <th>타임라인</th>
                        </tr>
                        <!-- {% for i in usb_results %}
                            <tr>
                                <td>
                                    {{loop.index}}
                                </td>
                                <td>
                                    <p>기술 유출</p>
                                </td>
                                <td>
                                    <p>USB</p>
                                </td>
                                <td>
                                    {{i['Start']}}
                                </td>
                                <td>
                                    {{i['Accessed_File_List']}}
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="showTimeline({{loop.index}}, 'usb')">
                                        타임라인 보기
                                    </button>
                                </td>
                            </tr>
                        {% endfor %} -->
                        {% for i in printer_results %}
                            <tr>
                                <td>
                                    {{loop.index}}
                                </td>
                                <td>
                                    <p>기술 유출</p>
                                </td>
                                <td>
                                    <p>프린터</p>
                                </td>
                                <td>
                                    {{i['Print_Event_Date']}}
                                </td>
                                <td>
                                    {{i['Accessed_File_List']}}
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="showTimeline({{loop.index}}, 'printer')">
                                        타임라인 보기
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</div>

<!-- 모달 수정 -->
<div class="modal fade" id="timelineModal" tabindex="-1" aria-labelledby="TimeLineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="TimeLineModalLabel">타임라인 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div id="modalTimeline"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery와 Bootstrap JS 추가 (head 또는 body 끝부분에) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>


<!-- Timeline 스크립트 수정 -->
<script>
// 한국어 locale 추가
var koLocale = {
    current: '현재',
    time: '시간',
    deleteSelected: '선택 항목 삭제',
    editable: {
        add: '추가',
        remove: '삭제',
        updateTime: '시간 수정'
    }
};

function showTimeline(index, type) {
    var timelineData = [];
    
    {% for events in timeline_data %}
        timelineData.push([
            {% for event in events %}
                {
                    id: {{ loop.index }},
                    content: '{{ event.name }}: {{ event.Content }}',
                    start: '{{ event.datetime }}',
                    type: 'point',
                    className: 'timeline-event-{{ event.type.lower() }}',
                    title: '{{ event.Content }}'
                },
            {% endfor %}
        ]);
    {% endfor %}

    // jQuery를 사용한 모달 표시
    jQuery('#timelineModal').modal('show');

    // 타임라인 생성
    setTimeout(() => {
        var container = document.getElementById('modalTimeline');
        var items = new vis.DataSet(timelineData[index - 1]);
        var options = {
            height: '900px',
            locale: 'ko',
            locales: {
                ko: koLocale
            },
            orientation: 'top',
            zoomable: true,
            tooltip: {
                followMouse: true,
                overflowMethod: 'cap'
            }
        };

        new vis.Timeline(container, items, options);
    }, 500);
}

// jQuery를 사용한 모달 이벤트 처리
jQuery('#timelineModal').on('hidden.bs.modal', function () {
    document.getElementById('modalTimeline').innerHTML = '';
});
</script>

<style>
/* 기존 스타일 유지 */
.modal-xl {
    max-width: 95%;
    margin: 1.75rem auto;
}

.modal-content {
    height: auto;
    min-height: 80vh;
}

#modalTimeline {
    background: white;
    padding: 20px;
    border-radius: 8px;
}

/* 타임라인 이벤트 스타일 유지 */
.timeline-event-create {
    background-color: #4CAF50 !important;
    border-color: #4CAF50 !important;
}

.timeline-event-delete {
    background-color: #f44336 !important;
    border-color: #f44336 !important;
}

.timeline-event-modify {
    background-color: #2196F3 !important;
    border-color: #2196F3 !important;
}

.timeline-event-rename {
    background-color: #FF9800 !important;
    border-color: #FF9800 !important;
}

.timeline-event-print {
    background-color: #9C27B0 !important;
    border-color: #9C27B0 !important;
}

.vis-item {
    color: white;
    border-radius: 3px;
    padding: 8px;
    font-size: 1.1em;
}
</style>

{% endblock content %}

{% block javascripts %}

{% endblock javascripts %}
